-- Create Regions Table
CREATE TABLE regions (
    region_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    region_name VARCHAR2(50) NOT NULL,
    manager_id NUMBER,
    sales_target NUMBER(12,2) DEFAULT 100000.00
);

-- Create Customers Table
CREATE TABLE customers (
    customer_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    first_name VARCHAR2(50) NOT NULL,
    last_name VARCHAR2(50) NOT NULL,
    email VARCHAR2(100) UNIQUE NOT NULL,
    region VARCHAR2(50),
    region_id NUMBER,
    signup_date DATE NOT NULL,
    customer_tier VARCHAR2(20) CHECK (customer_tier IN ('Bronze', 'Silver', 'Gold', 'Platinum')),
    CONSTRAINT fk_customers_region FOREIGN KEY (region_id) REFERENCES regions(region_id)
);

-- Create Products Table
CREATE TABLE products (
    product_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_name VARCHAR2(100) NOT NULL,
    category VARCHAR2(50) NOT NULL,
    price NUMBER(10,2) NOT NULL CHECK (price > 0),
    cost NUMBER(10,2) NOT NULL CHECK (cost >= 0),
    supplier_id NUMBER,
    created_date DATE DEFAULT SYSDATE
);

-- Create Transactions Table
CREATE TABLE transactions (
    transaction_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    customer_id NUMBER,
    product_id NUMBER,
    transaction_date TIMESTAMP NOT NULL,
    quantity NUMBER NOT NULL CHECK (quantity > 0),
    unit_price NUMBER(10,2) NOT NULL CHECK (unit_price > 0),
    total_amount NUMBER(10,2),
    payment_method VARCHAR2(30),
    CONSTRAINT fk_transactions_customer FOREIGN KEY (customer_id) REFERENCES customers(customer_id) ON DELETE SET NULL,
    CONSTRAINT fk_transactions_product FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE SET NULL
);

-- Create a trigger to automatically calculate total_amount
CREATE OR REPLACE TRIGGER calculate_total_amount
BEFORE INSERT OR UPDATE ON transactions
FOR EACH ROW
BEGIN
    :NEW.total_amount := :NEW.quantity * :NEW.unit_price;
END;
/

-- Now, insert sample data

-- 1. Insert into regions table
INSERT INTO regions (region_name, manager_id, sales_target) VALUES ('North America', 101, 250000.00);
INSERT INTO regions (region_name, manager_id, sales_target) VALUES ('Europe', 102, 180000.00);
INSERT INTO regions (region_name, manager_id, sales_target) VALUES ('Asia', 103, 150000.00);
INSERT INTO regions (region_name, manager_id, sales_target) VALUES ('South America', 104, 120000.00);
INSERT INTO regions (region_name, manager_id, sales_target) VALUES ('Australia', 105, 80000.00);

COMMIT;

-- 2. Insert into customers table
-- North America customers
INSERT INTO customers (first_name, last_name, email, region, region_id, signup_date, customer_tier) 
VALUES ('John', 'Smith', 'john.smith@email.com', 'North America', 1, TO_DATE('2023-01-15', 'YYYY-MM-DD'), 'Platinum');

INSERT INTO customers (first_name, last_name, email, region, region_id, signup_date, customer_tier) 
VALUES ('Emma', 'Johnson', 'emma.j@email.com', 'North America', 1, TO_DATE('2023-02-20', 'YYYY-MM-DD'), 'Gold');

INSERT INTO customers (first_name, last_name, email, region, region_id, signup_date, customer_tier) 
VALUES ('Michael', 'Davis', 'michael.d@email.com', 'North America', 1, TO_DATE('2023-03-10', 'YYYY-MM-DD'), 'Silver');

INSERT INTO customers (first_name, last_name, email, region, region_id, signup_date, customer_tier) 
VALUES ('Sarah', 'Wilson', 'sarah.w@email.com', 'North America', 1, TO_DATE('2023-04-05', 'YYYY-MM-DD'), 'Bronze');

INSERT INTO customers (first_name, last_name, email, region, region_id, signup_date, customer_tier) 
VALUES ('David', 'Brown', 'david.b@email.com', 'North America', 1, TO_DATE('2023-05-12', 'YYYY-MM-DD'), 'Gold');

-- Europe customers
INSERT INTO customers (first_name, last_name, email, region, region_id, signup_date, customer_tier) 
VALUES ('Sophie', 'Martin', 'sophie.m@email.fr', 'Europe', 2, TO_DATE('2023-02-28', 'YYYY-MM-DD'), 'Platinum');

INSERT INTO customers (first_name, last_name, email, region, region_id, signup_date, customer_tier) 
VALUES ('Thomas', 'Bernard', 'thomas.b@email.fr', 'Europe', 2, TO_DATE('2023-03-15', 'YYYY-MM-DD'), 'Gold');

INSERT INTO customers (first_name, last_name, email, region, region_id, signup_date, customer_tier) 
VALUES ('Anna', 'Schmidt', 'anna.s@email.de', 'Europe', 2, TO_DATE('2023-04-10', 'YYYY-MM-DD'), 'Silver');

-- Asia customers
INSERT INTO customers (first_name, last_name, email, region, region_id, signup_date, customer_tier) 
VALUES ('Wei', 'Chen', 'wei.chen@email.cn', 'Asia', 3, TO_DATE('2023-03-20', 'YYYY-MM-DD'), 'Gold');

INSERT INTO customers (first_name, last_name, email, region, region_id, signup_date, customer_tier) 
VALUES ('Yuki', 'Tanaka', 'yuki.t@email.jp', 'Asia', 3, TO_DATE('2023-04-15', 'YYYY-MM-DD'), 'Silver');

-- Customers with no purchases (for LEFT JOIN demo)
INSERT INTO customers (first_name, last_name, email, region, region_id, signup_date, customer_tier) 
VALUES ('Noah', 'Clark', 'noah.c@email.com', 'North America', 1, TO_DATE('2024-06-10', 'YYYY-MM-DD'), 'Bronze');

INSERT INTO customers (first_name, last_name, email, region, region_id, signup_date, customer_tier) 
VALUES ('Mia', 'Lewis', 'mia.l@email.com', 'Europe', 2, TO_DATE('2024-06-12', 'YYYY-MM-DD'), 'Bronze');

COMMIT;

-- 3. Insert into products table
INSERT INTO products (product_name, category, price, cost, supplier_id) 
VALUES ('Premium Wireless Headphones', 'Electronics', 299.99, 150.00, 201);

INSERT INTO products (product_name, category, price, cost, supplier_id) 
VALUES ('Smartphone Pro Max', 'Electronics', 1199.99, 650.00, 202);

INSERT INTO products (product_name, category, price, cost, supplier_id) 
VALUES ('Gaming Laptop', 'Electronics', 1599.99, 950.00, 203);

INSERT INTO products (product_name, category, price, cost, supplier_id) 
VALUES ('4K Ultra HD TV', 'Electronics', 899.99, 500.00, 204);

INSERT INTO products (product_name, category, price, cost, supplier_id) 
VALUES ('Wireless Earbuds', 'Electronics', 129.99, 60.00, 205);

-- Accessories
INSERT INTO products (product_name, category, price, cost, supplier_id) 
VALUES ('Laptop Backpack', 'Accessories', 59.99, 25.00, 301);

INSERT INTO products (product_name, category, price, cost, supplier_id) 
VALUES ('Phone Case', 'Accessories', 29.99, 10.00, 302);

-- Software
INSERT INTO products (product_name, category, price, cost, supplier_id) 
VALUES ('Office Suite Pro', 'Software', 249.99, 50.00, 401);

-- Products with no sales (for RIGHT JOIN demo)
INSERT INTO products (product_name, category, price, cost, supplier_id) 
VALUES ('VR Headset', 'Electronics', 499.99, 300.00, 209);

INSERT INTO products (product_name, category, price, cost, supplier_id) 
VALUES ('Fitness Tracker', 'Accessories', 79.99, 35.00, 306);

COMMIT;

-- 4. Insert into transactions table
-- January 2024 transactions
INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (1, 1, TIMESTAMP '2024-01-05 10:30:00', 1, 299.99, 'Credit Card');

INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (2, 2, TIMESTAMP '2024-01-08 14:15:00', 1, 1199.99, 'PayPal');

INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (3, 3, TIMESTAMP '2024-01-10 11:45:00', 1, 1599.99, 'Credit Card');

-- February 2024 transactions
INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (1, 3, TIMESTAMP '2024-02-02 11:15:00', 1, 1599.99, 'Credit Card');

INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (2, 6, TIMESTAMP '2024-02-05 09:30:00', 1, 59.99, 'PayPal');

INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (3, 7, TIMESTAMP '2024-02-08 16:20:00', 3, 29.99, 'Credit Card');

-- March 2024 transactions
INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (1, 2, TIMESTAMP '2024-03-01 10:30:00', 1, 1199.99, 'Credit Card');

INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (2, 1, TIMESTAMP '2024-03-03 14:15:00', 2, 299.99, 'PayPal');

INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (3, 4, TIMESTAMP '2024-03-05 11:45:00', 1, 899.99, 'Credit Card');

-- Europe customer transactions
INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (6, 1, TIMESTAMP '2024-01-25 12:30:00', 1, 299.99, 'Credit Card');

INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (7, 2, TIMESTAMP '2024-01-28 14:00:00', 1, 1199.99, 'PayPal');

-- Asia customer transactions
INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (9, 5, TIMESTAMP '2024-02-12 10:10:00', 2, 129.99, 'Credit Card');

INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (10, 6, TIMESTAMP '2024-02-15 14:30:00', 1, 59.99, 'PayPal');

-- April 2024 transactions
INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (1, 5, TIMESTAMP '2024-04-02 10:30:00', 1, 129.99, 'Credit Card');

INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (2, 7, TIMESTAMP '2024-04-05 14:15:00', 1, 29.99, 'PayPal');

-- May 2024 transactions
INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (3, 6, TIMESTAMP '2024-05-10 16:30:00', 1, 59.99, 'Credit Card');

INSERT INTO transactions (customer_id, product_id, transaction_date, quantity, unit_price, payment_method) 
VALUES (1, 8, TIMESTAMP '2024-05-01 10:30:00', 1, 249.99, 'Credit Card');

COMMIT;
-----------------------------------------------------------------------------------
------------------------PART A: SQL JOINs Implementation--------------------------
-- Retrieve complete transaction details with customer and product information
SELECT 
    t.transaction_id,
    TO_CHAR(t.transaction_date, 'YYYY-MM-DD') AS transaction_date,
    c.first_name || ' ' || c.last_name AS customer_name,
    c.region,
    p.product_name,
    t.quantity,
    t.unit_price,
    t.total_amount,
    p.category
FROM transactions t
INNER JOIN customers c ON t.customer_id = c.customer_id
INNER JOIN products p ON t.product_id = p.product_id
WHERE t.transaction_date >= TO_DATE('2024-01-01', 'YYYY-MM-DD')
ORDER BY t.transaction_date DESC;


-- Identify customers who have registered but never made a purchase
SELECT 
    c.customer_id,
    c.first_name || ' ' || c.last_name AS customer_name,
    c.email,
    TO_CHAR(c.signup_date, 'YYYY-MM-DD') AS signup_date,
    c.region,
    COUNT(t.transaction_id) AS transaction_count
FROM customers c
LEFT JOIN transactions t ON c.customer_id = t.customer_id
WHERE t.transaction_id IS NULL
GROUP BY c.customer_id, c.first_name, c.last_name, c.email, c.signup_date, c.region
ORDER BY c.signup_date DESC;

-- Detect products that have never been sold
SELECT 
    p.product_id,
    p.product_name,
    p.category,
    p.price,
    COUNT(t.transaction_id) AS sales_count,
    NVL(SUM(t.total_amount), 0) AS total_revenue
FROM transactions t
RIGHT JOIN products p ON t.product_id = p.product_id
GROUP BY p.product_id, p.product_name, p.category, p.price
HAVING COUNT(t.transaction_id) = 0
ORDER BY p.price DESC;

-- Comprehensive view comparing customers and products including unmatched records
SELECT 
    NVL(c.customer_id, 0) AS customer_id,
    NVL(c.first_name || ' ' || c.last_name, 'No Customer Data') AS customer_name,
    NVL(p.product_id, 0) AS product_id,
    NVL(p.product_name, 'No Product Data') AS product_name,
    COUNT(t.transaction_id) AS transaction_count,
    NVL(SUM(t.total_amount), 0) AS total_spent
FROM customers c
FULL OUTER JOIN transactions t ON c.customer_id = t.customer_id
FULL OUTER JOIN products p ON t.product_id = p.product_id
GROUP BY c.customer_id, c.first_name, c.last_name, p.product_id, p.product_name
HAVING COUNT(t.transaction_id) = 0
ORDER BY customer_id, product_id;

-- Compare customers within the same region by their spending patterns
WITH customer_spending AS (
    SELECT 
        c.customer_id,
        c.first_name || ' ' || c.last_name AS customer_name,
        c.region,
        COUNT(t.transaction_id) AS transaction_count,
        NVL(SUM(t.total_amount), 0) AS total_spent
    FROM customers c
    LEFT JOIN transactions t ON c.customer_id = t.customer_id
    GROUP BY c.customer_id, c.first_name, c.last_name, c.region
)
SELECT 
    c1.customer_id AS customer1_id,
    c1.customer_name AS customer1_name,
    c2.customer_id AS customer2_id,
    c2.customer_name AS customer2_name,
    c1.region,
    c1.transaction_count AS cust1_transactions,
    c2.transaction_count AS cust2_transactions,
    c1.total_spent AS cust1_total_spent,
    c2.total_spent AS cust2_total_spent,
    ABS(c1.total_spent - c2.total_spent) AS spending_difference
FROM customer_spending c1
JOIN customer_spending c2 ON c1.region = c2.region 
    AND c1.customer_id < c2.customer_id
WHERE c1.total_spent > 0 AND c2.total_spent > 0
    AND c1.region = 'North America'
ORDER BY spending_difference DESC;


---------------------Oracle Window Function Examples (For Part B)---------------------------------

-- 1: Ranking Functions (ROW_NUMBER, RANK, DENSE_RANK)
SELECT 
    c.region,
    p.product_name,
    SUM(t.total_amount) as total_revenue,
    ROW_NUMBER() OVER (PARTITION BY c.region ORDER BY SUM(t.total_amount) DESC) as row_num,
    RANK() OVER (PARTITION BY c.region ORDER BY SUM(t.total_amount) DESC) as revenue_rank,
    DENSE_RANK() OVER (PARTITION BY c.region ORDER BY SUM(t.total_amount) DESC) as dense_rank
FROM transactions t
JOIN customers c ON t.customer_id = c.customer_id
JOIN products p ON t.product_id = p.product_id
GROUP BY c.region, p.product_name
ORDER BY c.region, total_revenue DESC;

-- 2: Aggregate Window Functions
SELECT 
    TO_CHAR(TRUNC(transaction_date, 'MONTH'), 'YYYY-MM') as month,
    SUM(total_amount) as monthly_revenue,
    SUM(SUM(total_amount)) OVER (ORDER BY TRUNC(transaction_date, 'MONTH')) as running_total,
    AVG(SUM(total_amount)) OVER (ORDER BY TRUNC(transaction_date, 'MONTH') 
         ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) as three_month_avg
FROM transactions
GROUP BY TRUNC(transaction_date, 'MONTH')
ORDER BY month;

-- 3: Navigation Functions (LAG, LEAD)
SELECT 
    TO_CHAR(TRUNC(transaction_date, 'MONTH'), 'YYYY-MM') as month,
    SUM(total_amount) as current_month_revenue,
    LAG(SUM(total_amount), 1) OVER (ORDER BY TRUNC(transaction_date, 'MONTH')) as prev_month_revenue,
    ROUND(
        ((SUM(total_amount) - LAG(SUM(total_amount), 1) OVER (ORDER BY TRUNC(transaction_date, 'MONTH'))) /
        LAG(SUM(total_amount), 1) OVER (ORDER BY TRUNC(transaction_date, 'MONTH'))) * 100, 2
    ) as growth_percentage
FROM transactions
GROUP BY TRUNC(transaction_date, 'MONTH')
ORDER BY month;

-- 4: Distribution Functions (NTILE, CUME_DIST)
WITH customer_spending AS (
    SELECT 
        c.customer_id,
        c.first_name || ' ' || c.last_name as customer_name,
        SUM(t.total_amount) as lifetime_value,
        COUNT(t.transaction_id) as transaction_count
    FROM customers c
    LEFT JOIN transactions t ON c.customer_id = t.customer_id
    GROUP BY c.customer_id, c.first_name, c.last_name
)
SELECT 
    customer_id,
    customer_name,
    lifetime_value,
    transaction_count,
    NTILE(4) OVER (ORDER BY lifetime_value DESC NULLS LAST) as spending_quartile,
    ROUND(CUME_DIST() OVER (ORDER BY lifetime_value) * 100, 2) as percentile_rank
FROM customer_spending
ORDER BY lifetime_value DESC NULLS LAST;

-- Compare customers within the same region by their spending patterns
WITH customer_spending AS (
    SELECT 
        c.customer_id,
        c.first_name || ' ' || c.last_name AS customer_name,
        c.region,
        COUNT(t.transaction_id) AS transaction_count,
        NVL(SUM(t.total_amount), 0) AS total_spent
    FROM customers c
    LEFT JOIN transactions t ON c.customer_id = t.customer_id
    GROUP BY c.customer_id, c.first_name, c.last_name, c.region
)
SELECT 
    c1.customer_id AS customer1_id,
    c1.customer_name AS customer1_name,
    c2.customer_id AS customer2_id,
    c2.customer_name AS customer2_name,
    c1.region,
    c1.transaction_count AS cust1_transactions,
    c2.transaction_count AS cust2_transactions,
    c1.total_spent AS cust1_total_spent,
    c2.total_spent AS cust2_total_spent,
    ABS(c1.total_spent - c2.total_spent) AS spending_difference
FROM customer_spending c1
JOIN customer_spending c2 ON c1.region = c2.region 
    AND c1.customer_id < c2.customer_id
WHERE c1.total_spent > 0 AND c2.total_spent > 0
    AND c1.region = 'North America'
ORDER BY spending_difference DESC;



